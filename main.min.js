let currentWidgetId = null;
let currentSitekey = null;

function renderRecaptcha(sitekey) {
    const container = document.getElementById("recaptchaContainer");
    container.innerHTML = "";
    const recaptchaDiv = document.createElement("div");
    container.appendChild(recaptchaDiv);
    currentWidgetId = null;
    if (typeof grecaptcha !== "undefined" && grecaptcha.render) {
        currentWidgetId = grecaptcha.render(recaptchaDiv, {
            "sitekey": sitekey
        });
    }
}

window.onload = function() {
    // Verificar que RecaptchaConfig esté disponible
    if (typeof window.RecaptchaConfig === 'undefined' || typeof window.RecaptchaConfig.getSitekey !== 'function') {
        console.error('RecaptchaConfig no está disponible. Asegúrate de que config.js se cargó correctamente.');
        return;
    }
    
    // Obtener sitekey inicial después de que todo esté cargado
    currentSitekey = window.RecaptchaConfig.getSitekey();
    
    if (typeof grecaptcha !== "undefined") {
        renderRecaptcha(currentSitekey);
    }
    
    // Listener para cambio de ambiente
    document.querySelectorAll('input[name="environment"]').forEach(radio => {
        radio.addEventListener("change", function() {
            window.RecaptchaConfig.setEnvironment(this.value);
            currentSitekey = window.RecaptchaConfig.getSitekey();
            renderRecaptcha(currentSitekey);
        });
    });
    
    // Listener para cambio de app
    document.querySelectorAll('input[name="sitekey"]').forEach(radio => {
        radio.addEventListener("change", function() {
            const appType = this.getAttribute('data-app');
            window.RecaptchaConfig.setApp(appType);
            currentSitekey = window.RecaptchaConfig.getSitekey();
            renderRecaptcha(currentSitekey);
        });
    });
};

document.getElementById("captchaForm").addEventListener("submit", function (e) {
    e.preventDefault();
    const token = currentWidgetId !== null ? grecaptcha.getResponse(currentWidgetId) : grecaptcha.getResponse();

    if (token) {
        document.getElementById("tokenDisplay").textContent = token;
        document.getElementById("tokenContainer").style.display = "block";
        console.log("TOKEN:", token);
    } else {
        alert("Por favor completa el reCAPTCHA");
    }
});

document.getElementById("copyButton").addEventListener("click", function () {
    const token = document.getElementById("tokenDisplay").textContent;

    navigator.clipboard.writeText(token).then(function () {
        const button = document.getElementById("copyButton");
        const originalText = button.textContent;
        button.textContent = "¡Copiado!";
        button.classList.add("copied");

        setTimeout(function () {
            button.textContent = originalText;
            button.classList.remove("copied");
        }, 2000);
    }).catch(function (err) {
        alert("Error al copiar: " + err);
    });
});
